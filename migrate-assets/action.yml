name: "migrate-assets"
description: "POST/PATCH UiPath assets from assets.values.json; outputs migrated_ok and migrated_fail CSVs"
inputs:
  folder_name:    { description: "X-UIPATH-FolderPath value", required: true }

runs:
  using: "composite"
  steps:
  - name: Download results artifact
    uses: actions/download-artifact@v4
    with:
          name: assets
    continue-on-error: true

  - name: Migrate assets (POST/PATCH from list)
    shell: bash
    run: |
      set -euo pipefail
      test -f assets.json

      ok=()
      fail=()

      total=$(jq 'length' assets.json)
      echo "Migrating ${total} assets..."

      for ((i=0; i<total; i++)); do
        body=$(jq -c ".[$i]" assets.json)
        name=$(jq -r '.Name' <<<"$body")

        id=$(
          curl -sS -L \
            -H "Authorization: Bearer ${{ env.TOKEN}}" \
            -H "X-UIPATH-FolderPath: ${{ inputs.folder }}" \
            --get --data-urlencode "\$filter=Name eq '$name'" \
            "${OR_URL}/odata/Assets" \
          | jq -r '.value[0].Id // empty'
        )
        echo " asset id: $id"

        if [[ -n "$id" ]]; then
          response="$(mktemp)"
          trap 'rm -f "$response"' EXIT
          status=$(
            curl -L -sS \
              --connect-timeout 10 --max-time 120 \
              --output "$response" \
              --write-out '%{http_code}' \
              -X PATCH \
              -H "Authorization: Bearer ${{ env.TOKEN}}" \
              -H "Content-Type: application/json" \
              -H "X-UIPATH-FolderPath: ${{ inputs.folder }}" \
              --data-binary "$body" \
              "${OR_URL}/odata/Assets(${id})"
          )
          echo "Patch response: $status"
          echo "::group::Response body"
          if [[ -s "$response" ]] && command -v jq >/dev/null && jq -e . "$response" >/dev/null 2>&1; then
            jq -r . "$response"
          else
            cat "$response"
          fi
          echo "::endgroup::"
        else
          response="$(mktemp)"
          trap 'rm -f "$response"' EXIT
          status=$(
            curl -L -sS \
              --connect-timeout 10 --max-time 120 \
              --output "$response" \
              --write-out '%{http_code}' \
              -X POST \
              -H "Authorization: Bearer ${{ env.TOKEN }}" \
              -H "Content-Type: application/json" \
              -H "X-UIPATH-FolderPath: ${{ inputs.folder }}" \
              --data-binary "$body" \
              "${OR_URL}/odata/Assets"
          )
          echo "Post Response: $status"
          echo "::group::Response body"
          if [[ -s "$response" ]] && command -v jq >/dev/null && jq -e . "$response" >/dev/null 2>&1; then
            jq -r . "$response"
          else
            cat "$response"
          fi
          echo "::endgroup::"
        fi

        echo "[$((i+1))/${total}] ${name} -> ${status}"

        if [[ ${status:-0} -ge 200 && ${status:-0} -lt 400 ]]; then
          ok+=("$name")
        else
          fail+=("$name")
        fi
      done

      ok_csv=$(IFS=,; echo "${ok[*]-}")
      fail_csv=$(IFS=,; echo "${fail[*]-}")

      echo "Migrated OK:   ${ok_csv}"
      echo "Migrated FAIL: ${fail_csv}"

      echo "migrated_ok=${ok_csv}"     >> "$GITHUB_OUTPUT"
      echo "migrated_fail=${fail_csv}" >> "$GITHUB_OUTPUT"
